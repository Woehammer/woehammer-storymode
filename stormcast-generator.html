<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stormcast Eternals ‚Äì Story Mode Generator</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:#fff}
    .wrap{max-width:980px;margin:0 auto;border:1px solid #ddd;border-radius:12px;padding:16px;background:#fff}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .card{border:1px solid #e6e6e6;border-radius:12px;padding:12px;background:#fafafa;flex:1;min-width:260px}
    .btns{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#f3f3f3;font-weight:800;cursor:pointer}
    button:disabled{opacity:.45;cursor:not-allowed}
    button.primary{background:#1976d2;border-color:#1976d2;color:#fff}
    button.danger{background:#fff;border-color:#d32f2f;color:#d32f2f}
    button.good{background:#2e7d32;border-color:#2e7d32;color:#fff}
    button.warn{background:#f9a825;border-color:#f9a825;color:#111}
    button.bad{background:#c62828;border-color:#c62828;color:#fff}

    h3{margin:0 0 6px 0}
    .muted{color:#777;font-size:12px}
    .kv{margin:0;font-size:14px;line-height:1.4}
    .kv b{display:inline-block;min-width:110px}

    .output{margin:0;padding:16px;background:#fff;border-radius:12px;min-height:220px;border:1px solid #ddd;line-height:1.55}
    .output p{margin:0 0 10px 0}
    .output strong{font-weight:700}

    .section{margin:14px 0 10px 0;padding-top:12px;border-top:1px solid #e9e9e9}
    .section-title{font-size:13px;letter-spacing:.06em;text-transform:uppercase;color:#666;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:8px}

    .log-header{display:flex;align-items:center;gap:10px;margin:12px 0 6px 0}
    .log-icon{width:34px;height:34px;border-radius:10px;border:1px solid #e1e1e1;background:#f7f7f7;display:flex;align-items:center;justify-content:center;font-size:18px}

    .help{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;border:1px solid #d0d0d0;background:#f7f7f7;color:#555;font-weight:900;font-size:12px;line-height:1;cursor:help;position:relative;user-select:none;flex:0 0 auto}
    .help:focus{outline:2px solid #1976d2;outline-offset:2px}
    .help .tip{display:none;position:absolute;z-index:50;left:50%;transform:translateX(-50%);top:24px;width:min(420px,82vw);background:#111;color:#fff;border-radius:10px;padding:10px 12px;font-size:12px;font-weight:600;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .help .tip::before{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);border-width:0 6px 6px 6px;border-style:solid;border-color:transparent transparent #111 transparent}
    .help:hover .tip,.help:focus .tip{display:block}

    .logbox{border:1px solid #ddd;border-radius:12px;background:#fff;padding:12px;margin-top:10px}
    .entry{border-top:1px solid #eee;padding-top:10px;margin-top:10px}
    .entry:first-child{border-top:none;margin-top:0;padding-top:0}
    .entry-title{font-weight:900;margin:0 0 6px 0}
    .entry-meta{margin:0 0 6px 0}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ddd;background:#f7f7f7;font-size:12px;font-weight:900;margin-left:6px}
    .pill.good{background:#e7f6ea;border-color:#b7e0bf;color:#1b5e20}
    .pill.warn{background:#fff4d6;border-color:#ffe09a;color:#6d4c00}
    .pill.bad{background:#fde7e7;border-color:#f6bcbc;color:#7f1d1d}
    .pill.state{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}

    .incidentBox{
      border:1px dashed #d7d7d7;
      border-radius:12px;
      padding:12px;
      margin-top:10px;
      background:#fcfcfc;
    }
    .incidentPrompt{margin:0 0 10px 0}
    .choiceList{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .choiceList button{flex:1;min-width:220px}

    .inlineRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-weight:800;background:#fff}

    .divider{height:1px;background:#e9e9e9;margin:12px 0}
  </style>
</head>

<body>
<div class="wrap" id="storymode-stormcast">
  <h3>Stormcast Eternals ‚Äì Story Mode Generator</h3>
  <p class="muted">Optional narrative aide. No rules impact. Saved locally in your browser.</p>

  <div class="row" style="margin-top:12px;">
    <div class="card">
      <h3 style="font-size:16px;">Current Character</h3>
      <p class="kv"><b>Realm:</b> <span id="cur-realm">‚Äî</span></p>
      <p class="kv"><b>General:</b> <span id="cur-general">‚Äî</span></p>
      <p class="kv"><b>Background:</b> <span id="cur-bg">‚Äî</span></p>

      <p class="kv"><b>Reputation:</b> <span id="cur-rep">‚Äî</span>
        <span class="pill state" id="cur-state" style="margin-left:8px;display:none;">‚Äî</span>
      </p>

      <p class="kv">
        <b>Mission:</b> <span id="cur-mission">‚Äî</span>
        <span class="help" tabindex="0" aria-label="Mission help">?
          <span class="tip">
            <b>Mission</b> is just story flavour. A label for what the next battle feels like (Incursion, Pursuit, etc).
            <br><br>
            You can still play <b>any</b> games you want: casual, competitive, GHB battleplans, Path to Glory, or Spearhead, against <b>any</b> opponent.
            This tool never forces a scenario, it just gives narrative context.
          </span>
        </span>
      </p>

      <div class="btns">
        <button id="btn-reset" class="danger" type="button">Reset Character</button>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:16px;">Actions</h3>

      <div class="btns">
        <button id="btn-all" class="primary" type="button">Generate Full Starter</button>
        <button id="btn-general" type="button">Roll General</button>
        <button id="btn-mission" type="button">Roll Mission</button>
        <button id="btn-hook" type="button">Roll Battle Hook</button>
        <button id="btn-interlude" type="button">Roll Interlude</button>
        <button id="btn-copy" type="button">Copy</button>
      </div>

      <div class="divider"></div>

      <!-- POST-BATTLE RESULT MOVED HERE: directly above incident -->
      <div class="section" style="border-top:none;padding-top:0;margin-top:0;">
        <div class="section-title">
          Post Battle Result
          <span class="help" tabindex="0" aria-label="Post-battle help">?
            <span class="tip">After you play the game, pick Win/Draw/Loss to generate an After Action report and save the Battle # to the Campaign Log. This also updates your characters Reputation.</span>
          </span>
        </div>
        <div class="btns" style="margin-top:8px;">
          <button id="btn-win" class="good" type="button">Win</button>
          <button id="btn-draw" class="warn" type="button">Draw</button>
          <button id="btn-loss" class="bad" type="button">Loss</button>
        </div>
        <p class="muted" style="margin:0;">Tip: If incidents are set to ‚ÄúAlways‚Äù, one will trigger after you log the result.</p>
      </div>

      <div class="section" style="border-top:none;padding-top:0;margin-top:10px;">
        <div class="section-title">
          Between Battles Incident (Optional)
          <span class="help" tabindex="0" aria-label="Incident help">?
            <span class="tip">
              Incidents are short narrative choices between games. Your choice may affect your <b>Reputation</b> and can set the path of your <b>next Mission</b>.
              Consequences are hidden until you choose.
            </span>
          </span>
        </div>

        <div class="inlineRow" style="margin-top:8px;">
          <label style="font-weight:900;color:#444;">Frequency:</label>
          <select id="incident-mode">
            <option value="optional">Optional</option>
            <option value="always">Always</option>
            <option value="never">Never</option>
          </select>
          <span class="help" tabindex="0" aria-label="Incident frequency help">?
            <span class="tip">
              <b>Optional</b>: you choose when to roll incidents.
              <br>
              <b>Always</b>: an incident triggers automatically after each battle result.
              <br>
              <b>Never</b>: incidents are disabled.
            </span>
          </span>
        </div>

        <div class="btns" style="margin-top:10px;">
          <button id="btn-incident" type="button">Roll Incident</button>
        </div>

        <p class="muted" id="incident-mode-note" style="margin:0;"></p>

        <!-- Incident box now lives HERE so it‚Äôs in the right place -->
        <div id="incidentBox" class="incidentBox" style="display:none;"></div>
      </div>

      <p class="muted" style="margin:0;">Reminder: this is for narrative flavour only. Play whatever battleplan you like.</p>
    </div>
  </div>

  <div class="log-header">
    <div class="log-icon">üìú</div>
    <h3>Campaign Log</h3>
  </div>

  <div id="out" class="output">
    <p class="muted">Ready. Click <strong>Generate Full Starter</strong>.</p>
  </div>

  <div class="logbox">
    <div class="section-title" style="margin-bottom:10px;">
      History
      <span class="help" tabindex="0" aria-label="Help">?
        <span class="tip">This log is stored in your browser. Copy it out if you want a permanent record.</span>
      </span>
    </div>

    <div class="btns" style="margin-top:0;">
      <button id="btn-copy-log" type="button">Copy Log</button>
      <button id="btn-clear-log" class="danger" type="button">Clear Log</button>
    </div>

    <div id="log"></div>
  </div>
</div>

<script>
(function(){
  // IMPORTANT: keep a stable storage key so saved characters don‚Äôt ‚Äúvanish‚Äù
  const STORAGE = "woehammer_stormcast_story_v12_full";
  const pick = a => a[Math.floor(Math.random()*a.length)];
  const roll = n => Math.floor(Math.random()*n)+1;
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));

  function weightedPick(items, weightFn){
    let total = 0;
    const weights = items.map(it => {
      const w = Math.max(0, Number(weightFn(it)) || 0);
      total += w;
      return w;
    });
    if(total <= 0) return pick(items);
    let r = Math.random() * total;
    for(let i=0;i<items.length;i++){
      r -= weights[i];
      if(r <= 0) return items[i];
    }
    return items[items.length-1];
  }

  let state = {};
  try { state = JSON.parse(localStorage.getItem(STORAGE) || "{}"); }
  catch { state = {}; }

  if(!Array.isArray(state.log)) state.log = [];
  if(typeof state.reputation !== "number") state.reputation = 5;
  if(typeof state.crisis !== "boolean") state.crisis = false;
  if(typeof state.renownedTriggered !== "boolean") state.renownedTriggered = false;
  if(typeof state.incidentMode !== "string") state.incidentMode = "optional"; // optional | always | never

  const save = () => localStorage.setItem(STORAGE, JSON.stringify(state));
  const clearAll = () => localStorage.removeItem(STORAGE);

  const realms = ["Aqshy","Ghyran","Shyish","Ghur","Chamon","Ulgu"];

  const firstNames = ["Aster","Lyra","Kaelis","Brannic","Seraphine","Garran","Odrin","Merek","Siora","Eamon","Vexan","Thane","Rydan","Elara","Cassian","Orien","Kora","Damaris","Sevrin","Marrec"];
  const lastNames  = ["Valorn","Dawnward","Stormvein","Goldsign","Halospear","Ironlight","Truthbrand","Ashward","Skywrath","Steelward","Windstride","Brightfall","Sunmantle","Vigilant","Lightbearer","Stormcrown","Aethermark","Gilded","Hearthward","Sigilguard"];

  const backgrounds = [
    {k:"reforged",l:"Many-Times Reforged (Memories Fraying)"},
    {k:"new",l:"Freshly Forged (New to Immortality)"},
    {k:"redeemer",l:"Redeemer (Oath to Protect the Helpless)"},
    {k:"slayer",l:"Slayer (Hunts a Specific Foe)"},
    {k:"prophet",l:"Vision-Bound (Dreams and Portents)"},
    {k:"judge",l:"Celestial Judge (No Mercy for Corruption)"}
  ];

  const missionTypes = ["Incursion","Pursuit","Defence","Assault","Escalation","Revelation"];

  const battleHooks = {
    Incursion:[
      "A sudden assault strikes an area you previously thought secure. You must muster quickly, march your force, and drive the attackers back before they slip away with whatever they came for.",
      "Raiders appear from hidden paths at dusk, hitting supply wagons and outposts. If you don‚Äôt respond, your forces will suffer.",
      "Enemy scouts and light troops push into your territory, testing your response. Break them now or they‚Äôll map every weakness you have.",
      "Pickets vanish overnight. Smoke rises from a hamlet that swore it was loyal. Something is probing your lines and it‚Äôs learning fast.",
      "A covert landing or sudden portal-surge brings enemies into your rear. You have one chance to contain it before panic spreads."
    ],
    Pursuit:[
      "The enemy is falling back, wounded but dangerous. You can let them escape and regroup‚Ä¶ or you can chase them down and finish them on your terms.",
      "A rearguard buys time with brutal efficiency. Every mile you gain costs blood, but if you relent, the enemy will be gone by morning.",
      "You catch glimpses of fleeing banners through smoke and rain. If you can force a battle before they reach safety, you might end this quickly.",
      "The foe retreats into rough ground. Speed wins, but haste will hand them an ambush.",
      "You press them through night and day. When the fight comes, it will be desperate and close."
    ],
    Defence:[
      "You are forced to hold ground against pressure. If your line breaks, everything behind it becomes vulnerable.",
      "A key position must be defended (bridge, shrine, road, or gate). The enemy knows it too, and they are coming in strength.",
      "You take shelter in contested ground and prepare to weather the storm. Survival is victory enough, for now.",
      "A refugee column chokes the road behind your lines. You must hold long enough to get them through.",
      "Your allies‚Äô morale buckles. If you can‚Äôt anchor their flank, the whole front will collapse."
    ],
    Assault:[
      "You march to strike a hardened enemy position. This won‚Äôt be a skirmish, but a deliberate blow meant to break them.",
      "A fortified position blocks your progress. You must take it before the campaign stalls.",
      "You choose the battlefield and attack with purpose. The enemy will remember this day.",
      "The foe has overextended. A swift hammerblow now could shatter their momentum.",
      "Your scouts find the enemy‚Äôs supply hub. Destroy it, and the war changes pace."
    ],
    Escalation:[
      "The conflict widens. Reinforcements arrive, strongpoints are seized, and the war becomes impossible to ignore.",
      "Positions harden on the front lines. Both sides commit fully. Supplies, morale, and reputations are on the line.",
      "What began as skirmishes becomes open warfare. Strike hard now, or you‚Äôll be fighting a stronger enemy later.",
      "A neighbouring power takes notice and intervenes. Now every action has consequences beyond the battlefield.",
      "The enemy brings heavier forces. If you don‚Äôt match them, you‚Äôll be ground down."
    ],
    Revelation:[
      "Victory may uncover something you weren‚Äôt meant to find (a truth, a relic, or a betrayal). Now you fight to control what is known.",
      "Evidence suggests the enemy was never acting alone. Your next battle is against soldiers and the hidden hand behind them.",
      "A pattern becomes undeniable. The war is part of something older and darker than you knew.",
      "You find proof that a trusted ally has been compromised. To act openly risks internal conflict, but to stay silent risks more.",
      "A relic, map, prisoner, or omen points to a hidden site. Whoever holds it shapes the next chapter."
    ]
  };

  const interludes = {
    base:[
      "Mortals look to you as a myth made real and expect miracles.",
      "Orders from Azyr conflict with reality on the ground.",
      "A memory surfaces that should not exist.",
      "A chamber-astrolabe in your camp ticks backwards for an hour, then shatters.",
      "Azyrite scribes ask for names of the fallen. You hesitate longer than you should.",
      "Your wargear hums with distant thunder, as if answering a call you cannot hear."
    ],
    reforged:[
      "You see a face in the crowd that died centuries ago‚Ä¶ and it looks back.",
      "A name catches in your throat. You know it‚Äôs important. You cannot remember why.",
      "Your hands move through an old ritual you never learned‚Ä¶ except you did."
    ],
    new:[
      "Immortality settles in, heavier than expected.",
      "You feel the storm within you flare at a mortal‚Äôs simple kindness.",
      "You realise you don‚Äôt know how to go home, not truly."
    ],
    redeemer:[
      "A plea for protection arrives at the worst possible moment.",
      "Children tie crude lightning-charms to your cloak. You don‚Äôt remove them.",
      "A village priest asks if Sigmar still listens. You answer too honestly."
    ],
    slayer:[
      "You glimpse a sign that your quarry is close and it makes you reckless.",
      "A weapon-mark matches the one you hunt. The trail is warm.",
      "A dying foe whispers the name you‚Äôve sworn to end."
    ],
    judge:[
      "Corruption is found among allies. Justice will fracture trust.",
      "A confession arrives‚Ä¶ and it‚Äôs politically inconvenient.",
      "You catch yourself smiling at the thought of punishment. That worries you."
    ],
    prophet:[
      "A dream leaves you certain of the next battlefield‚Ä¶ and afraid of it.",
      "You wake with ash on your tongue and a map in your mind.",
      "A ‚Äòcoincidence‚Äô repeats three times. The pattern is screaming at you."
    ]
  };

  const afterAction = {
    Incursion:{ win:["The raiders are driven off and their prize denied. Survivors scatter, but you‚Äôve learned this wasn‚Äôt random.","You reclaim the ground. Whatever they came for remains out of reach, for now."],
               draw:["You blunt the attack, but the enemy escapes with questions unanswered.","It feels less like a win and more like a warning written in blood."],
               loss:["They strike, take what they came for, and vanish. The area is no longer secure.","You‚Äôre forced back. The next fight will be fought on worse terms."] },
    Pursuit:{ win:["You run them down. A retreat becomes a rout and you seize momentum.","You catch their rearguard and break it. The survivors flee without order."],
              draw:["They slip away at the last. You‚Äôve hurt them, but not ended them.","A messy fight in bad ground. You deny them safety, but not escape."],
              loss:["The pursuit turns. You overextend and pay for it.","They escape the net and regain their footing while you regroup."] },
    Defence:{ win:["You hold. The line does not break, and the enemy learns your resolve.","The enemy throws itself against your position and fails. Morale steadies."],
              draw:["You hold at cost. The ground remains contested, and the next assault will be worse.","Neither side breaks. You buy time, but not certainty."],
              loss:["The position falls. You withdraw under pressure, and the enemy‚Äôs shadow lengthens.","Your defence collapses. Now you must survive long enough to strike back."] },
    Assault:{ win:["Your attack lands true. The enemy‚Äôs position cracks and collapses.","You seize the point and turn it into a spearhead for what comes next."],
              draw:["You gain ground, but not the break you wanted. The enemy clings on.","Your assault stalls. You‚Äôll need a new angle or more strength."],
              loss:["You‚Äôre thrown back from the objective. The enemy holds and your losses bite.","The assault fails. Worse: the enemy now knows you can bleed."] },
    Escalation:{ win:["A decisive blow. The wider war shifts in your favour.","You take ground, morale, and initiative. The campaign has a new shape."],
                 draw:["The front line forms here. Neither side gains the clear upper hand.","The war widens, but the decision is delayed, for now."],
                 loss:["Your position collapses under pressure. The enemy claims initiative.","You‚Äôre forced to react. Reinforcements will be needed, quickly."] },
    Revelation:{ win:["You win ‚Äî and the truth is yours to wield. The enemy fought hard to keep it hidden.","The discovery changes everything. The next step isn‚Äôt victory, it‚Äôs containment."],
                 draw:["You gain fragments, not certainty. Enough to worry you, not enough to act cleanly.","You were inches from answers before the enemy slipped away."],
                 loss:["The enemy escapes with secrets intact or worse, with proof you didn‚Äôt want to be real.","You withdraw before the truth can be seized. Ignorance will cost you later."] }
  };

  function getStateLabel(){
    if(state.reputation <= 0) return "Disgraced";
    if(state.reputation >= 10) return "Renowned";
    return "Steady";
  }

  function checkThresholds(){
    state.reputation = clamp(state.reputation, -5, 15);

    if(state.reputation <= 0 && !state.crisis){
      state.crisis = true;
      state.log.push({ kind:"state", text:"Reputation has collapsed. Your authority is in question. You must win your next battle or risk removal from command.", ts: Date.now() });
    }
    if(state.reputation >= 10 && !state.renownedTriggered){
      state.renownedTriggered = true;
      state.log.push({ kind:"state", text:"Your reputation has grown. Allies seek your leadership, and expectations rise with every order you give.", ts: Date.now() });
    }
  }

  // ---------- INCIDENT TABLES ----------
  // Each incident: title, prompt, optional weights{bgKey: bonus}, choices[3]
  // choices: { text, repDelta, nextMission, outcome }
  const incidents = {
    standard: [
      // Background-tilted starters
      { title:"Reforging Echo",
        prompt:"During reforging rites, a memory resurfaces, something you should not remember.",
        weights:{ reforged:4, prophet:1 },
        choices:[
          { text:"Confide in a trusted Stormcast", repDelta:+1, nextMission:"Revelation", outcome:"You share the fragment. It points to something hidden and dangerous." },
          { text:"Record it and set it aside", repDelta:0, nextMission:"Incursion", outcome:"You commit it to record. The war continues. The question lingers." },
          { text:"Suppress it entirely", repDelta:-1, nextMission:"Escalation", outcome:"You bury the memory. It does not stay buried. Conflict grows around you." }
        ]},
      { title:"Mortal Petition",
        prompt:"A nearby settlement sends envoys, begging for protection against an encroaching threat.",
        weights:{ redeemer:3 },
        choices:[
          { text:"Redeploy immediately to aid them", repDelta:+1, nextMission:"Defence", outcome:"You divert at once. The mortals see your banners and dare to hope." },
          { text:"Promise aid once objectives are secured", repDelta:0, nextMission:"Incursion", outcome:"You send reassurance and press on, but danger doesn‚Äôt wait politely." },
          { text:"Refuse. The war effort takes priority", repDelta:-1, nextMission:"Pursuit", outcome:"You deny the request. Word spreads quickly, and not kindly." }
        ]},
      { title:"Captured Enemy Officer",
        prompt:"An enemy officer is taken alive after a sharp skirmish.",
        weights:{ judge:2, prophet:1 },
        choices:[
          { text:"Interrogate them thoroughly", repDelta:0, nextMission:"Revelation", outcome:"Under pressure, they reveal fragments of a larger design." },
          { text:"Turn them over to mortal authorities", repDelta:+1, nextMission:"Incursion", outcome:"You delegate justice. The mortals see you as firm and fair." },
          { text:"Execute them immediately", repDelta:-1, nextMission:"Pursuit", outcome:"Swift judgement. The enemy will respond in kind." }
        ]},
      { title:"Lost Relic Rumour",
        prompt:"A rumour spreads of a lost relic nearby. It could be nothing, or decisive.",
        weights:{ prophet:3 },
        choices:[
          { text:"Investigate personally", repDelta:+1, nextMission:"Revelation", outcome:"You follow the lead. It feels uncomfortably familiar." },
          { text:"Send a detachment quietly", repDelta:0, nextMission:"Incursion", outcome:"You delegate. The war doesn‚Äôt pause for treasure hunts." },
          { text:"Ignore it entirely", repDelta:-1, nextMission:"Assault", outcome:"You focus on the enemy, not myths. The enemy may not share your restraint." }
        ]},
      { title:"Enemy Banner Sighted",
        prompt:"A notorious enemy banner is sighted. Its presence changes the tone of the campaign.",
        weights:{ slayer:3 },
        choices:[
          { text:"Hunt it down immediately", repDelta:0, nextMission:"Pursuit", outcome:"You commit to the chase. There will be no half-measures." },
          { text:"Fortify and prepare for its attack", repDelta:+1, nextMission:"Defence", outcome:"You ready the field. If they come, they‚Äôll come into your teeth." },
          { text:"Strike elsewhere to avoid it", repDelta:-1, nextMission:"Assault", outcome:"You bypass it. Some see prudence; others see fear." }
        ]},
      { title:"Corruption Unmasked",
        prompt:"Evidence of corruption appears among allies, subtle, spreading, and hard to prove.",
        weights:{ judge:4, prophet:1 },
        choices:[
          { text:"Purge it immediately", repDelta:0, nextMission:"Assault", outcome:"You act without hesitation. The message is clear: no rot survives." },
          { text:"Investigate quietly and gather proof", repDelta:+1, nextMission:"Revelation", outcome:"You build a case. The truth is uglier than expected." },
          { text:"Ignore it, the war comes first", repDelta:-1, nextMission:"Escalation", outcome:"You postpone judgement. The rot grows in the dark." }
        ]},

      // Big pool (50+). Keep these varied and short so it doesn‚Äôt get samey.
      { title:"Rival Stormcast",
        prompt:"Another commander questions one of your decisions in front of the host.",
        choices:[
          { text:"Confront them openly", repDelta:0, nextMission:"Assault", outcome:"You meet challenge with certainty. The next battle will prove who is right." },
          { text:"Settle it privately", repDelta:+1, nextMission:"Incursion", outcome:"Quiet words, measured tone. Unity holds, barely, and you march again." },
          { text:"Ignore it", repDelta:-1, nextMission:"Defence", outcome:"Silence reads as weakness to some. Your next stand will be watched closely." }
        ]},
      { title:"Enemy Survivors",
        prompt:"Scouts report enemy survivors regrouping after the last engagement.",
        choices:[
          { text:"Pursue them relentlessly", repDelta:0, nextMission:"Pursuit", outcome:"You refuse to let them breathe. The hunt begins." },
          { text:"Fortify and deny targets", repDelta:+1, nextMission:"Defence", outcome:"You harden your position and force them to come to you." },
          { text:"Ignore them, push elsewhere", repDelta:-1, nextMission:"Escalation", outcome:"You move on. The enemy grows bolder behind you." }
        ]},
      { title:"Sigmar‚Äôs Omen",
        prompt:"An unnatural storm breaks over your camp the night before marching.",
        weights:{ prophet:1, new:1 },
        choices:[
          { text:"Declare it a sign of favour", repDelta:+1, nextMission:"Assault", outcome:"You raise your voice and the host listens. Tomorrow, you strike." },
          { text:"Treat it as coincidence", repDelta:0, nextMission:"Incursion", outcome:"You keep your counsel. The enemy won‚Äôt be impressed by weather." },
          { text:"Dismiss it as superstition", repDelta:-1, nextMission:"Defence", outcome:"Some bristle. Morale stiffens, not in a good way." }
        ]},
      { title:"Broken Bridge",
        prompt:"A key crossing is destroyed. The detour will cost days.",
        choices:[
          { text:"Force a crossing anyway", repDelta:0, nextMission:"Assault", outcome:"You gamble on speed. It will be bloody, but decisive." },
          { text:"Hold and build a replacement", repDelta:+1, nextMission:"Defence", outcome:"You secure the area and rebuild. Slow, but controlled." },
          { text:"Take the long way around", repDelta:-1, nextMission:"Pursuit", outcome:"You lose momentum. The enemy gains room to breathe." }
        ]},
      { title:"Azyrite Envoy",
        prompt:"An envoy arrives with advice that feels political rather than practical.",
        choices:[
          { text:"Follow the envoy‚Äôs guidance", repDelta:0, nextMission:"Escalation", outcome:"You comply. The war widens, and you inherit new obligations." },
          { text:"Listen, then choose your own course", repDelta:+1, nextMission:"Incursion", outcome:"You show respect, and independence. Results will speak." },
          { text:"Dismiss them outright", repDelta:-1, nextMission:"Defence", outcome:"You gain freedom, and make enemies in Azyr." }
        ]},
      { title:"Supply Wagons",
        prompt:"Your supply line is threatened by raids and sabotage.",
        choices:[
          { text:"Set a trap and strike the raiders", repDelta:+1, nextMission:"Incursion", outcome:"You lure them in and smash them. The road feels safer ‚Äî for now." },
          { text:"Escort the wagons personally", repDelta:0, nextMission:"Defence", outcome:"You protect what matters. The campaign slows but steadies." },
          { text:"Press on without supplies", repDelta:-1, nextMission:"Assault", outcome:"You gamble on victory over logistics. Hunger will collect its due." }
        ]},
      { title:"Refugee Column",
        prompt:"A river of refugees clogs the road behind your lines.",
        choices:[
          { text:"Guard them through the danger", repDelta:+1, nextMission:"Defence", outcome:"The mortals survive. They will remember your banners." },
          { text:"Redirect them to a safer route", repDelta:0, nextMission:"Incursion", outcome:"You improvise. Some are saved, some vanish into the wilds." },
          { text:"Order them off the road", repDelta:-1, nextMission:"Pursuit", outcome:"You clear the path ‚Äî and seed bitterness behind you." }
        ]},
      { title:"Whispered Heresy",
        prompt:"A priest claims Sigmar has ‚Äòabandoned‚Äô this region. Panic flickers.",
        choices:[
          { text:"Address the host and mortals together", repDelta:+1, nextMission:"Defence", outcome:"Your words steady hands. Faith hardens into resolve." },
          { text:"Have the priest questioned", repDelta:0, nextMission:"Revelation", outcome:"The source of the rumour‚Ä¶ is not mortal." },
          { text:"Make an example of them", repDelta:-1, nextMission:"Assault", outcome:"Order returns ‚Äî but at a cost. Fear is a poor cement." }
        ]},
      { title:"Bitter Ally",
        prompt:"A local ally resents Stormcast authority and undermines your orders.",
        choices:[
          { text:"Offer them a share of glory", repDelta:+1, nextMission:"Assault", outcome:"Their pride is soothed. They commit fully to the next strike." },
          { text:"Keep them at arm‚Äôs length", repDelta:0, nextMission:"Defence", outcome:"You limit risk. Cooperation becomes cold and transactional." },
          { text:"Replace their leadership", repDelta:-1, nextMission:"Escalation", outcome:"You take control. The region‚Äôs politics erupt." }
        ]},
      { title:"Enemy Messenger",
        prompt:"A lone messenger offers terms ‚Äî or a distraction.",
        choices:[
          { text:"Hear them out", repDelta:0, nextMission:"Revelation", outcome:"You learn something useful. Whether it‚Äôs true is another matter." },
          { text:"Use them to feed false information", repDelta:+1, nextMission:"Incursion", outcome:"You plant bait. The enemy bites ‚Äî exactly where you want." },
          { text:"Execute the messenger", repDelta:-1, nextMission:"Pursuit", outcome:"You refuse the game. The enemy plays anyway." }
        ]},
      { title:"Night Watch",
        prompt:"Your pickets report shapes moving beyond torchlight. The darkness feels‚Ä¶ alive.",
        choices:[
          { text:"Launch a probing attack", repDelta:0, nextMission:"Incursion", outcome:"You push into the night. The enemy wasn‚Äôt expecting courage." },
          { text:"Fortify and wait for dawn", repDelta:+1, nextMission:"Defence", outcome:"You deny the night its prey. Dawn brings certainty." },
          { text:"Move camp immediately", repDelta:-1, nextMission:"Pursuit", outcome:"You withdraw. The host whispers the word ‚Äòfear‚Äô." }
        ]},
      { title:"Lightning Scar",
        prompt:"A bolt strikes near your command tent, leaving a rune-burned scar in the earth.",
        weights:{ prophet:2, reforged:1 },
        choices:[
          { text:"Interpret it as a warning", repDelta:+1, nextMission:"Revelation", outcome:"You follow the sign and discover something hidden nearby." },
          { text:"Treat it as random", repDelta:0, nextMission:"Incursion", outcome:"You shrug and march. The rune remains behind like an accusation." },
          { text:"Declare it a blessing and attack", repDelta:-1, nextMission:"Assault", outcome:"You hype the host ‚Äî perhaps too much. Expectations spike." }
        ]},
      { title:"Border Skirmish",
        prompt:"A neutral force clashes with your scouts. They claim you trespass.",
        choices:[
          { text:"Apologise and withdraw", repDelta:+1, nextMission:"Defence", outcome:"You avoid a wider mess. Diplomacy buys breathing room." },
          { text:"Stand your ground and negotiate", repDelta:0, nextMission:"Revelation", outcome:"You talk with steel close at hand. You learn what they truly fear." },
          { text:"Drive them off", repDelta:-1, nextMission:"Escalation", outcome:"You win the moment and start a new front." }
        ]},
      { title:"A Lost Patrol",
        prompt:"A patrol is missing. Their last signal ended mid-sentence.",
        choices:[
          { text:"Search immediately", repDelta:+1, nextMission:"Incursion", outcome:"You find them ‚Äî or what‚Äôs left ‚Äî and the trail points outward." },
          { text:"Hold and investigate carefully", repDelta:0, nextMission:"Revelation", outcome:"Evidence suggests the enemy is testing your reactions." },
          { text:"Ignore it and push the main plan", repDelta:-1, nextMission:"Assault", outcome:"You press on. The missing become a rumour that sours morale." }
        ]},
      { title:"Munitions Shortage",
        prompt:"Your mortal allies report dwindling ammunition and supplies.",
        choices:[
          { text:"Pause to secure resupply", repDelta:+1, nextMission:"Defence", outcome:"You stabilise the situation. The next battle is fought properly equipped." },
          { text:"Raid the enemy stores", repDelta:0, nextMission:"Assault", outcome:"You hit their logistics. It‚Äôs risky ‚Äî and effective." },
          { text:"Press on regardless", repDelta:-1, nextMission:"Escalation", outcome:"You gamble on fury. The campaign pays in blood." }
        ]},
      { title:"Unwanted Idol",
        prompt:"Your troops find a strange idol. It ‚Äòfeels‚Äô wrong even through gauntlets.",
        weights:{ judge:2, prophet:2 },
        choices:[
          { text:"Destroy it publicly", repDelta:+1, nextMission:"Assault", outcome:"You shatter it. The host cheers. Something screams without a mouth." },
          { text:"Secure it for study", repDelta:0, nextMission:"Revelation", outcome:"Knowledge is dangerous ‚Äî but ignorance is worse." },
          { text:"Hide it and move on", repDelta:-1, nextMission:"Incursion", outcome:"You bury it. Later, it is found somewhere else." }
        ]},
      { title:"Stormhost Pride",
        prompt:"Your warriors argue over doctrine and pride ‚Äî a Stormhost split in miniature.",
        choices:[
          { text:"Enforce unity with strict orders", repDelta:0, nextMission:"Defence", outcome:"You impose discipline. It holds ‚Äî but feels brittle." },
          { text:"Let captains prove themselves in battle", repDelta:+1, nextMission:"Assault", outcome:"You channel pride into purpose. The next strike will be fierce." },
          { text:"Refuse the dispute and walk away", repDelta:-1, nextMission:"Pursuit", outcome:"The issue festers. You feel it in every delayed response." }
        ]},
      { title:"A Mortal Champion",
        prompt:"A mortal hero offers to lead a risky mission in your name.",
        choices:[
          { text:"Accept and support them", repDelta:+1, nextMission:"Incursion", outcome:"The mortals see partnership ‚Äî not dominance." },
          { text:"Let them go alone", repDelta:0, nextMission:"Revelation", outcome:"They return with knowledge‚Ä¶ and wounds that don‚Äôt make sense." },
          { text:"Refuse and do it yourself", repDelta:-1, nextMission:"Assault", outcome:"You deny them glory. Some resent you for it." }
        ]},
      { title:"Enemy Fortifications",
        prompt:"Scouts report the enemy is building hardpoints and trenches.",
        choices:[
          { text:"Strike before they finish", repDelta:0, nextMission:"Assault", outcome:"You attack early. Speed matters more than perfection." },
          { text:"Prepare a defensive answer", repDelta:+1, nextMission:"Defence", outcome:"You match them methodically. The war becomes positional." },
          { text:"Outflank and ignore them", repDelta:-1, nextMission:"Pursuit", outcome:"You bypass their wall ‚Äî and leave a dagger at your back." }
        ]},
      { title:"The Wrong Dead",
        prompt:"Bodies on the field wear the wrong insignia ‚Äî not the enemy you expected.",
        choices:[
          { text:"Investigate immediately", repDelta:+1, nextMission:"Revelation", outcome:"The trail points to a hidden player." },
          { text:"Assume confusion and carry on", repDelta:0, nextMission:"Escalation", outcome:"You press on. Confusion becomes chaos later." },
          { text:"Suppress the news", repDelta:-1, nextMission:"Defence", outcome:"You control panic ‚Äî and sacrifice truth." }
        ]},
      { title:"Broken Vows",
        prompt:"A local ally breaks a promise and abandons a watchpost.",
        choices:[
          { text:"Forgive ‚Äî you need them", repDelta:+1, nextMission:"Defence", outcome:"You keep the coalition intact. Trust is wounded, not dead." },
          { text:"Demand restitution", repDelta:0, nextMission:"Incursion", outcome:"They comply reluctantly. Cooperation becomes tense." },
          { text:"Punish them publicly", repDelta:-1, nextMission:"Escalation", outcome:"You restore order ‚Äî and spark resentment." }
        ]},
      { title:"Surprise Reinforcements",
        prompt:"Unexpected reinforcements arrive ‚Äî eager, untested, and looking to you.",
        choices:[
          { text:"Deploy them carefully", repDelta:+1, nextMission:"Defence", outcome:"You build a stable line. Their confidence grows." },
          { text:"Throw them into the next strike", repDelta:0, nextMission:"Assault", outcome:"They learn fast. Some don‚Äôt learn long." },
          { text:"Send them elsewhere", repDelta:-1, nextMission:"Pursuit", outcome:"You lose strength on the main front. Others take the credit." }
        ]},
      { title:"A Strange Silence",
        prompt:"For a full day, no enemy signs appear. Too quiet.",
        choices:[
          { text:"Probe forward cautiously", repDelta:+1, nextMission:"Incursion", outcome:"You find the trap‚Äôs outline and refuse it." },
          { text:"Fortify and wait", repDelta:0, nextMission:"Defence", outcome:"You deny the enemy initiative. The fight comes on your terms." },
          { text:"March at full speed", repDelta:-1, nextMission:"Pursuit", outcome:"You rush into the unknown. It rushes back." }
        ]},
      { title:"Azyrite Scholar",
        prompt:"A scholar insists a local site is ‚Äòkey‚Äô to the war ‚Äî but won‚Äôt say why.",
        choices:[
          { text:"Escort them to the site", repDelta:+1, nextMission:"Revelation", outcome:"The place matters. The scholar was not wrong ‚Äî just scared." },
          { text:"Send guards and stay focused", repDelta:0, nextMission:"Incursion", outcome:"You split attention. It works‚Ä¶ barely." },
          { text:"Refuse and press on", repDelta:-1, nextMission:"Assault", outcome:"You choose war over mystery. Mysteries rarely accept no." }
        ]},
      { title:"The Quarry‚Äôs Sign",
        prompt:"You find a mark matching a foe you‚Äôve sworn to hunt.",
        weights:{ slayer:3 },
        choices:[
          { text:"Chase the sign immediately", repDelta:0, nextMission:"Pursuit", outcome:"You follow the trail. It pulls you toward a confrontation." },
          { text:"Set an ambush and wait", repDelta:+1, nextMission:"Defence", outcome:"You turn the hunt into a trap. Patience becomes a weapon." },
          { text:"Ignore it and hit the main enemy", repDelta:-1, nextMission:"Assault", outcome:"You deny obsession ‚Äî but it denies you peace." }
        ]},
      { title:"Unsteady Captain",
        prompt:"A mortal captain under your command is losing nerve.",
        choices:[
          { text:"Inspire them personally", repDelta:+1, nextMission:"Defence", outcome:"They rally. Your presence is a storm-wall behind their spine." },
          { text:"Replace them quietly", repDelta:0, nextMission:"Incursion", outcome:"You avoid a scene. The unit stabilises." },
          { text:"Publicly shame them", repDelta:-1, nextMission:"Escalation", outcome:"Fear spreads faster than courage." }
        ]},
      { title:"Hostile Terrain",
        prompt:"The land itself fights you ‚Äî choking mists, razor winds, bitter rain.",
        choices:[
          { text:"Slow down and secure routes", repDelta:+1, nextMission:"Defence", outcome:"You reduce losses. Time is the price." },
          { text:"Push through anyway", repDelta:0, nextMission:"Pursuit", outcome:"You keep pressure, but your troops pay the toll." },
          { text:"Detour to easier ground", repDelta:-1, nextMission:"Incursion", outcome:"You stay safe ‚Äî and lose initiative." }
        ]},
      { title:"Secret Meeting",
        prompt:"Scouts report a covert enemy meeting at an abandoned shrine.",
        choices:[
          { text:"Strike it immediately", repDelta:0, nextMission:"Incursion", outcome:"You crash the gathering. You don‚Äôt catch them all ‚Äî but you learn enough." },
          { text:"Watch and gather evidence", repDelta:+1, nextMission:"Revelation", outcome:"You identify leaders and patterns. The next battle will be targeted." },
          { text:"Ignore ‚Äî it‚Äôs a trap", repDelta:-1, nextMission:"Defence", outcome:"Maybe it was. Maybe it wasn‚Äôt. Now you‚Äôll never know." }
        ]},
      { title:"Enemy Provocation",
        prompt:"The enemy defiles a symbol of Sigmar within sight of your camp.",
        choices:[
          { text:"Respond with immediate violence", repDelta:0, nextMission:"Assault", outcome:"You smash them. The host feels better ‚Äî and hungrier." },
          { text:"Hold discipline, choose the ground", repDelta:+1, nextMission:"Defence", outcome:"You refuse the bait. Your restraint becomes a weapon." },
          { text:"Send mortals to handle it", repDelta:-1, nextMission:"Incursion", outcome:"It keeps you safe ‚Äî and makes you look distant." }
        ]},
      { title:"A Sudden Betrayal",
        prompt:"A guide or informant feeds you false routes. You realise mid-march.",
        choices:[
          { text:"Reverse course and cut them off", repDelta:+1, nextMission:"Pursuit", outcome:"You pivot sharply. The enemy almost admires it." },
          { text:"Accept it and improvise", repDelta:0, nextMission:"Incursion", outcome:"You adapt. The war becomes messy but survivable." },
          { text:"Punish everyone involved", repDelta:-1, nextMission:"Escalation", outcome:"You restore fear-based order ‚Äî and poison loyalty." }
        ]},
      { title:"Relic-Bound Field",
        prompt:"The battlefield hums with ancient magic. Every step feels watched.",
        weights:{ prophet:1, reforged:1, judge:1 },
        choices:[
          { text:"Secure the site and investigate", repDelta:+1, nextMission:"Revelation", outcome:"You find a clue that changes how you understand the war." },
          { text:"Fight quickly and leave", repDelta:0, nextMission:"Incursion", outcome:"You keep it practical. The site stays‚Ä¶ unresolved." },
          { text:"Seal it and forbid entry", repDelta:-1, nextMission:"Defence", outcome:"You control danger ‚Äî and lock away potential answers." }
        ]},
      { title:"Enemy Supplies Spotted",
        prompt:"You discover a poorly guarded enemy supply cache.",
        choices:[
          { text:"Raid it immediately", repDelta:+1, nextMission:"Assault", outcome:"You burn their stores. Their next battle will be hungrier." },
          { text:"Set a trap and wait", repDelta:0, nextMission:"Defence", outcome:"You turn their greed into your advantage." },
          { text:"Mark it and move on", repDelta:-1, nextMission:"Pursuit", outcome:"You pass it by. Later you wish you hadn‚Äôt." }
        ]},
      { title:"False Flag",
        prompt:"An attack is staged to look like another faction. It‚Äôs meant to start a wider war.",
        choices:[
          { text:"Expose the deception", repDelta:+1, nextMission:"Revelation", outcome:"You reveal the truth before alliances fracture." },
          { text:"Use the confusion to strike the enemy", repDelta:0, nextMission:"Assault", outcome:"You exploit the moment. Morality is messier than strategy." },
          { text:"Let the rumour spread", repDelta:-1, nextMission:"Escalation", outcome:"You allow chaos to bloom. It blooms back." }
        ]},
      { title:"Stormvault Door",
        prompt:"A sealed Stormvault door is found half-buried. It was not on any map.",
        weights:{ prophet:2, judge:1 },
        choices:[
          { text:"Attempt to open it", repDelta:+1, nextMission:"Revelation", outcome:"The lock yields ‚Äî and the contents change your priorities." },
          { text:"Guard it and request orders", repDelta:0, nextMission:"Defence", outcome:"You secure the site. Time passes. The enemy notices." },
          { text:"Seal it and move on", repDelta:-1, nextMission:"Incursion", outcome:"You choose war over secrets. Secrets rarely accept neglect." }
        ]},
      { title:"A Strange Ally",
        prompt:"A mysterious figure offers help‚Ä¶ with demands they won‚Äôt explain.",
        choices:[
          { text:"Accept cautiously", repDelta:0, nextMission:"Revelation", outcome:"You gain knowledge. You also gain doubt." },
          { text:"Refuse and rely on your own", repDelta:+1, nextMission:"Defence", outcome:"You choose certainty over shortcuts. The host respects it." },
          { text:"Use them as bait", repDelta:-1, nextMission:"Incursion", outcome:"It works. You feel worse than the enemy." }
        ]},
      { title:"Weather Turns",
        prompt:"A sudden heatwave/freeze floods the region. Movement becomes hazardous.",
        choices:[
          { text:"Hold and secure shelter", repDelta:+1, nextMission:"Defence", outcome:"You protect the mortals. They‚Äôll follow you anywhere now." },
          { text:"Push the enemy while they suffer too", repDelta:0, nextMission:"Pursuit", outcome:"You keep pressure. Both sides bleed from the land." },
          { text:"Abandon the area entirely", repDelta:-1, nextMission:"Escalation", outcome:"You relocate. Someone else takes your ground." }
        ]},
      { title:"Enemy Champion Challenges You",
        prompt:"A champion issues a challenge meant to undermine your authority.",
        choices:[
          { text:"Accept publicly", repDelta:+1, nextMission:"Assault", outcome:"You meet them head-on. The host roars approval." },
          { text:"Refuse and focus on strategy", repDelta:0, nextMission:"Defence", outcome:"You deny theatrics. Some call it wisdom; some call it fear." },
          { text:"Send a subordinate", repDelta:-1, nextMission:"Incursion", outcome:"You avoid risk ‚Äî and look distant." }
        ]},
      { title:"A Cold Realisation",
        prompt:"A mortal thanks you. You can‚Äôt remember what gratitude used to feel like.",
        weights:{ reforged:2, new:1 },
        choices:[
          { text:"Lean into the bond with mortals", repDelta:+1, nextMission:"Defence", outcome:"You anchor yourself in what you protect. It steadies you." },
          { text:"Treat it as irrelevant", repDelta:0, nextMission:"Incursion", outcome:"You keep distance. Distance becomes habit." },
          { text:"Reject it harshly", repDelta:-1, nextMission:"Assault", outcome:"You cut the thread. The host feels colder." }
        ]},

      // Fillers to push variety beyond 50
      { title:"Enemy Map",
        prompt:"A crude map is found on a corpse. It marks places you didn‚Äôt know mattered.",
        choices:[
          { text:"Follow the map immediately", repDelta:+1, nextMission:"Revelation", outcome:"You find the marked site before the enemy can erase it." },
          { text:"Cross-check with scouts", repDelta:0, nextMission:"Incursion", outcome:"You verify before committing. The enemy stays active." },
          { text:"Ignore it as bait", repDelta:-1, nextMission:"Defence", outcome:"Maybe it was bait. Maybe it was your only clue." }
        ]},
      { title:"Tainted Water",
        prompt:"Local wells are poisoned. Mortals grow weak and fearful.",
        choices:[
          { text:"Secure clean water and hold", repDelta:+1, nextMission:"Defence", outcome:"You stabilise the region. Trust rises with health." },
          { text:"Hunt the poisoners", repDelta:0, nextMission:"Pursuit", outcome:"You chase them through scrub and ruin. You‚Äôll catch them eventually." },
          { text:"Leave it for locals to solve", repDelta:-1, nextMission:"Escalation", outcome:"A small horror becomes a bigger one." }
        ]},
      { title:"Screams in the Fog",
        prompt:"At dawn, screams echo from the fog beyond your perimeter. No bodies are found.",
        choices:[
          { text:"Probe with a fast strike", repDelta:0, nextMission:"Incursion", outcome:"You push into the mist. Something pushes back." },
          { text:"Hold firm and tighten watches", repDelta:+1, nextMission:"Defence", outcome:"You deny the fear its feast. The host steadies." },
          { text:"Advance at full speed to end it", repDelta:-1, nextMission:"Assault", outcome:"You rush forward. The fog swallows your confidence." }
        ]},
      { title:"A Funeral Pyre",
        prompt:"Mortals ask you to honour their dead with a proper rite.",
        choices:[
          { text:"Attend and speak", repDelta:+1, nextMission:"Defence", outcome:"Your presence becomes a shield. The living stand straighter." },
          { text:"Send a representative", repDelta:0, nextMission:"Incursion", outcome:"You respect them‚Ä¶ from a distance." },
          { text:"Refuse ‚Äî war waits", repDelta:-1, nextMission:"Pursuit", outcome:"You march. Behind you, grief curdles into anger." }
        ]},
      { title:"Caged Lightning",
        prompt:"A device hums with storm-energy. Someone has learned to trap your power.",
        choices:[
          { text:"Destroy it now", repDelta:+1, nextMission:"Assault", outcome:"You crush the device. The air tastes cleaner." },
          { text:"Study it for clues", repDelta:0, nextMission:"Revelation", outcome:"It reveals methods ‚Äî and an enemy mind at work." },
          { text:"Hide it and move on", repDelta:-1, nextMission:"Incursion", outcome:"It won‚Äôt stay hidden. It never does." }
        ]},
      { title:"An Arrow of Gold",
        prompt:"A single golden arrow is delivered with no message. It points west.",
        weights:{ prophet:2 },
        choices:[
          { text:"Follow the sign", repDelta:+1, nextMission:"Revelation", outcome:"You find the origin ‚Äî and the reason it was sent." },
          { text:"Send scouts only", repDelta:0, nextMission:"Incursion", outcome:"You hedge your bets. The war keeps moving." },
          { text:"Ignore it as nonsense", repDelta:-1, nextMission:"Escalation", outcome:"The ‚Äònonsense‚Äô becomes a problem later." }
        ]},
      { title:"Banner-Repair",
        prompt:"Your banner is torn. Mortals insist it‚Äôs a bad omen unless repaired before the next clash.",
        choices:[
          { text:"Let the mortals repair it", repDelta:+1, nextMission:"Defence", outcome:"They stitch hope into cloth. It matters more than it should." },
          { text:"Repair it yourself in silence", repDelta:0, nextMission:"Incursion", outcome:"You do the work. The host notices." },
          { text:"Refuse and march", repDelta:-1, nextMission:"Pursuit", outcome:"You reject superstition. Morale disagrees." }
        ]},
      { title:"Enemy Prisoners Beg",
        prompt:"Prisoners beg for mercy, claiming they were coerced.",
        weights:{ judge:2, redeemer:1 },
        choices:[
          { text:"Offer clemency with conditions", repDelta:+1, nextMission:"Revelation", outcome:"One tells you something valuable in gratitude ‚Äî or fear." },
          { text:"Imprison and move on", repDelta:0, nextMission:"Defence", outcome:"You keep order. Mercy becomes paperwork." },
          { text:"Execute them", repDelta:-1, nextMission:"Assault", outcome:"Fear spreads. It works ‚Äî until it doesn‚Äôt." }
        ]},
      { title:"A Missing Relic",
        prompt:"A Stormcast relic is missing from your vault. Someone close had access.",
        choices:[
          { text:"Investigate quietly", repDelta:+1, nextMission:"Revelation", outcome:"You uncover a chain of secrets ‚Äî and a weak link." },
          { text:"Lock everything down", repDelta:0, nextMission:"Defence", outcome:"You tighten control. The host resents the suspicion." },
          { text:"Ignore it ‚Äî focus on war", repDelta:-1, nextMission:"Escalation", outcome:"The relic resurfaces‚Ä¶ in enemy hands." }
        ]},
      { title:"A Signal Fire",
        prompt:"A distant signal fire burns ‚Äî not yours. Someone calls for help or war.",
        choices:[
          { text:"Go to them", repDelta:+1, nextMission:"Incursion", outcome:"You respond. The world feels slightly less cruel." },
          { text:"Send aid, keep marching", repDelta:0, nextMission:"Defence", outcome:"You split resources. It might be enough." },
          { text:"Ignore it", repDelta:-1, nextMission:"Pursuit", outcome:"You choose efficiency. The world chooses consequences." }
        ]},
      { title:"Enemy Wardstones",
        prompt:"Wardstones appear along the road. They dampen the air and make prayers feel thin.",
        weights:{ prophet:1, judge:1 },
        choices:[
          { text:"Smash them and push on", repDelta:+1, nextMission:"Assault", outcome:"You break the stones. The air ‚Äòbreathes‚Äô again." },
          { text:"Study them and trace their source", repDelta:0, nextMission:"Revelation", outcome:"The stones point to a larger ritual." },
          { text:"Avoid them entirely", repDelta:-1, nextMission:"Defence", outcome:"You reroute. The enemy controls your movement." }
        ]},
    ],

    disgraced: [
      { title:"Cold Reception",
        prompt:"Allies meet you with forced smiles and guarded eyes. Your reputation precedes you.",
        choices:[
          { text:"Ask for a chance to prove yourself", repDelta:+1, nextMission:"Defence", outcome:"You swallow pride. They offer a fragile opportunity." },
          { text:"Demand obedience", repDelta:0, nextMission:"Assault", outcome:"You force the issue. It will work ‚Äî or explode." },
          { text:"Withdraw and operate alone", repDelta:-1, nextMission:"Pursuit", outcome:"You go to ground. Alone is quieter‚Ä¶ and harder." }
        ]},
      { title:"Orders Withheld",
        prompt:"Azyr‚Äôs messages arrive late or incomplete. You are being ‚Äòmanaged‚Äô.",
        choices:[
          { text:"Hold position and rebuild trust", repDelta:+1, nextMission:"Defence", outcome:"You stabilise the front and show reliability." },
          { text:"Act decisively without permission", repDelta:0, nextMission:"Assault", outcome:"You seize initiative. It must succeed." },
          { text:"Ignore Azyr entirely", repDelta:-1, nextMission:"Escalation", outcome:"You choose independence. Politics turns sharp." }
        ]},
      { title:"Rumours in the Ranks",
        prompt:"Your mortals whisper that you are cursed ‚Äî that Sigmar‚Äôs gaze has turned away.",
        choices:[
          { text:"Speak to them plainly", repDelta:+1, nextMission:"Defence", outcome:"You meet fear with truth. It steadies some." },
          { text:"Crush the rumourmakers", repDelta:0, nextMission:"Assault", outcome:"You end the whispers. You also end trust." },
          { text:"Ignore it", repDelta:-1, nextMission:"Incursion", outcome:"The rumour grows legs and runs ahead of you." }
        ]},
      { title:"Denied Supplies",
        prompt:"Supplies are ‚Äòmisfiled‚Äô. Your host goes without what it needs.",
        choices:[
          { text:"Secure supplies by force", repDelta:0, nextMission:"Assault", outcome:"You take what you need. You make enemies doing it." },
          { text:"Live lean and fight smart", repDelta:+1, nextMission:"Pursuit", outcome:"You adapt. Your discipline becomes a weapon." },
          { text:"Retreat to resupply properly", repDelta:-1, nextMission:"Defence", outcome:"You fall back. The enemy advances." }
        ]},
      { title:"A ‚ÄòReplacement‚Äô Arrives",
        prompt:"A senior Stormcast arrives ‚Äòto help‚Äô ‚Äî clearly to supervise you.",
        choices:[
          { text:"Welcome them and cooperate", repDelta:+1, nextMission:"Defence", outcome:"You swallow pride. The host becomes steadier." },
          { text:"Compete with them openly", repDelta:0, nextMission:"Assault", outcome:"You turn the war into a proving ground." },
          { text:"Undermine them quietly", repDelta:-1, nextMission:"Revelation", outcome:"You play politics. Politics plays back." }
        ]},
      { title:"Hostile Locals",
        prompt:"Locals refuse shelter and spit at your standard. Your failures are remembered.",
        choices:[
          { text:"Protect them anyway", repDelta:+1, nextMission:"Defence", outcome:"You do the right thing. Some hearts soften." },
          { text:"Move on and ignore them", repDelta:0, nextMission:"Pursuit", outcome:"You leave bitterness behind you." },
          { text:"Make an example", repDelta:-1, nextMission:"Escalation", outcome:"Fear returns order. It also returns hate." }
        ]},
      { title:"A Private Warning",
        prompt:"A trusted ally quietly warns: one more failure and you‚Äôll be removed from command.",
        choices:[
          { text:"Plan conservatively and hold", repDelta:+1, nextMission:"Defence", outcome:"You stabilise. It‚Äôs not glorious, but it‚Äôs survival." },
          { text:"Gamble on a decisive strike", repDelta:0, nextMission:"Assault", outcome:"You bet everything. The next battle decides your fate." },
          { text:"Disappear into a shadow war", repDelta:-1, nextMission:"Incursion", outcome:"You avoid judgement by avoiding everyone." }
        ]},
      { title:"Burnt Orders",
        prompt:"Your written orders are found burned in a campfire. Someone is sabotaging you.",
        choices:[
          { text:"Hunt the saboteur", repDelta:+1, nextMission:"Revelation", outcome:"You uncover the knife behind the smile." },
          { text:"Tighten security and move", repDelta:0, nextMission:"Pursuit", outcome:"You stop bleeding time and get back to the enemy." },
          { text:"Blame the wrong person publicly", repDelta:-1, nextMission:"Escalation", outcome:"You pick a scapegoat. The real traitor smiles." }
        ]},
    ],

    renowned: [
      { title:"Calls for Aid",
        prompt:"Multiple allies ask for your banner. They believe you can turn their war.",
        choices:[
          { text:"Commit to a big offensive", repDelta:+1, nextMission:"Escalation", outcome:"You take command. The war becomes larger ‚Äî and yours." },
          { text:"Choose one precise strike", repDelta:0, nextMission:"Assault", outcome:"You focus the blow. Precision beats spectacle." },
          { text:"Delay to gather intelligence", repDelta:-1, nextMission:"Revelation", outcome:"You slow the tempo. Some call it wisdom; others call it fear." }
        ]},
      { title:"Hero Worship",
        prompt:"Mortals treat you like a saint. It‚Äôs dangerous for them‚Ä¶ and for you.",
        choices:[
          { text:"Use it to strengthen morale", repDelta:+1, nextMission:"Defence", outcome:"Hope hardens the line. The enemy breaks against it." },
          { text:"Keep distance and stay practical", repDelta:0, nextMission:"Incursion", outcome:"You remain efficient. The myth stays intact." },
          { text:"Reject them harshly", repDelta:-1, nextMission:"Pursuit", outcome:"You cut the cult. It leaves a hollow behind you." }
        ]},
      { title:"Azyr‚Äôs Attention",
        prompt:"Azyr watches you closely now. Every success creates new expectations.",
        choices:[
          { text:"Accept the responsibility", repDelta:+1, nextMission:"Escalation", outcome:"You step into the spotlight. The war turns into a campaign." },
          { text:"Balance orders with reality", repDelta:0, nextMission:"Defence", outcome:"You hold the line and manage politics ‚Äî barely." },
          { text:"Resist Azyr‚Äôs pressure", repDelta:-1, nextMission:"Revelation", outcome:"You insist on truth. Truth makes powerful enemies." }
        ]},
      { title:"Enemy Hunts You",
        prompt:"The enemy begins targeting you specifically. You are now the prize.",
        choices:[
          { text:"Set a counter-trap", repDelta:+1, nextMission:"Defence", outcome:"You bait them and crush their killers." },
          { text:"Strike first and keep moving", repDelta:0, nextMission:"Pursuit", outcome:"You deny them a clean shot. The chase becomes constant." },
          { text:"Ignore the threat", repDelta:-1, nextMission:"Assault", outcome:"You stay bold. Bold bleeds." }
        ]},
      { title:"A Gift of Steel",
        prompt:"A master-smith offers you a new weapon ‚Äî if you use it publicly.",
        choices:[
          { text:"Accept and display it", repDelta:+1, nextMission:"Assault", outcome:"The host‚Äôs confidence spikes. The enemy takes notice." },
          { text:"Accept but keep it quiet", repDelta:0, nextMission:"Incursion", outcome:"You gain power without the theatre." },
          { text:"Refuse the politics", repDelta:-1, nextMission:"Revelation", outcome:"You offend someone influential. The war gains a shadow." }
        ]},
      { title:"Rivals Gather",
        prompt:"Other commanders grow jealous. They begin circling like sharks.",
        choices:[
          { text:"Share credit and uplift others", repDelta:+1, nextMission:"Defence", outcome:"You build allies. Jealousy cools into respect." },
          { text:"Ignore them and keep winning", repDelta:0, nextMission:"Escalation", outcome:"You race ahead. The pack follows ‚Äî hungry." },
          { text:"Crush dissent publicly", repDelta:-1, nextMission:"Assault", outcome:"You win the argument with force. It creates enemies." }
        ]},
      { title:"The People‚Äôs Champion",
        prompt:"A town declares you their protector and refuses to evacuate without your promise.",
        choices:[
          { text:"Swear to protect them", repDelta:+1, nextMission:"Defence", outcome:"Your oath becomes a shield ‚Äî and a chain." },
          { text:"Evacuate them and move on", repDelta:0, nextMission:"Incursion", outcome:"You save lives. The war keeps moving." },
          { text:"Force them to leave", repDelta:-1, nextMission:"Pursuit", outcome:"It‚Äôs efficient. It‚Äôs ugly. They won‚Äôt forget." }
        ]},
      { title:"A Great Omen",
        prompt:"Prophets proclaim your next battle will ‚Äòdecide the region‚Äô. That‚Äôs‚Ä¶ too much pressure.",
        weights:{ prophet:2 },
        choices:[
          { text:"Use the prophecy to unite allies", repDelta:+1, nextMission:"Escalation", outcome:"You turn words into momentum. The war swells around you." },
          { text:"Downplay it and focus", repDelta:0, nextMission:"Assault", outcome:"You refuse theatrics. Steel will decide." },
          { text:"Mock the prophecy", repDelta:-1, nextMission:"Defence", outcome:"You cut superstition ‚Äî and accidentally cut morale." }
        ]},
    ]
  };

  function pickIncidentPool(){
    if(state.reputation <= 0) return incidents.disgraced;
    if(state.reputation >= 10) return incidents.renowned;
    return incidents.standard;
  }

  function pickIncidentWeighted(pool){
    const bgKey = state.general?.bgKey || null;
    return weightedPick(pool, (inc) => {
      let w = 1;
      if(bgKey && inc.weights && typeof inc.weights[bgKey] === "number"){
        w += inc.weights[bgKey];
      }
      // tiny nudges by state
      if(state.reputation <= 0){
        if(inc.choices?.some(c => c.nextMission === "Defence")) w += 0.4;
      }
      if(state.reputation >= 10){
        if(inc.choices?.some(c => c.nextMission === "Escalation" || c.nextMission === "Assault" || c.nextMission === "Revelation")) w += 0.3;
      }
      return w;
    });
  }

  function ensureRealm(){
    if(!state.realm){ state.realm = pick(realms); save(); }
  }

  function rollGeneral(){
    const bg = pick(backgrounds);
    state.general = { name: `${pick(firstNames)} ${pick(lastNames)}`, bgKey: bg.k, bgLabel: bg.l };
    save();
  }

  function rollMission(){
    state.missionType = pick(missionTypes);
    state.lastHook = null;
    save();
    return state.missionType;
  }

  function rollBattleHook(){
    const t = state.missionType || rollMission();
    const hook = pick(battleHooks[t] || ["(No hooks defined yet.)"]);
    state.lastHook = { type: t, text: hook };
    save();
    return state.lastHook;
  }

  function threat(){
    const r = roll(6)+roll(6);
    if(r<=3) return "Enemy weakened (-15‚Äì25%)";
    if(r<=6) return "Enemy slightly weakened";
    if(r<=9) return "Even forces";
    if(r<=11) return "Enemy reinforced (+10‚Äì15%)";
    return "Enemy heavily reinforced (+25%)";
  }

  function section(title, body, tooltipText){
    const help = tooltipText ? `<span class="help" tabindex="0" aria-label="Help">?<span class="tip">${tooltipText}</span></span>` : "";
    return `<div class="section"><div class="section-title">${title} ${help}</div>${body}</div>`;
  }

  function header(){ return `<p><strong>Realm:</strong> ${state.realm}</p>`; }

  function generalBlock(){
    if(!state.general) return `<p class="muted">No general yet. Click <strong>Roll General</strong>.</p>`;
    return `
      <p><strong>General:</strong> ${state.general.name}</p>
      <p><strong>Background:</strong> ${state.general.bgLabel}</p>
      <p><strong>Reputation:</strong> ${state.reputation} (${getStateLabel()})</p>
      <p><strong>Mission:</strong> ${state.missionType || "‚Äî"}</p>
    `;
  }

  function battleHookBlock(){
    if(!state.missionType) rollMission();
    if(!state.lastHook || state.lastHook.type !== state.missionType) rollBattleHook();
    return section("Battle Hook",
      `<p><strong>${state.lastHook.type}:</strong> ${state.lastHook.text}</p>`,
      "This is a story prompt for why the next game is happening. It does not dictate your battleplan."
    );
  }

  function renderCurrent(){
    document.getElementById("cur-realm").textContent = state.realm || "‚Äî";
    document.getElementById("cur-general").textContent = state.general?.name || "‚Äî";
    document.getElementById("cur-bg").textContent = state.general?.bgLabel || "‚Äî";
    document.getElementById("cur-rep").textContent = (typeof state.reputation === "number") ? String(state.reputation) : "‚Äî";
    const s = getStateLabel();
    const pill = document.getElementById("cur-state");
    pill.style.display = "inline-block";
    pill.textContent = s;
    document.getElementById("cur-mission").textContent = state.missionType || "‚Äî";
  }

  function renderLog(){
    const logDiv = document.getElementById("log");
    if(!state.log.length){
      logDiv.innerHTML = `<p class="muted">No history yet. Log a battle result or roll an incident.</p>`;
      return;
    }

    const items = state.log.slice().reverse().map(entry => {
      if(entry.kind === "battle"){
        const pillClass = entry.result === "Win" ? "good" : entry.result === "Draw" ? "warn" : "bad";
        return `
          <div class="entry">
            <p class="entry-title">Battle ${entry.number} <span class="pill ${pillClass}">${entry.result}</span></p>
            <p class="entry-meta"><strong>Mission:</strong> ${entry.mission}</p>
            <p class="entry-meta"><strong>Hook:</strong> ${entry.hook}</p>
            <p class="entry-meta"><strong>After Action:</strong> ${entry.after}</p>
          </div>
        `;
      }
      if(entry.kind === "incident"){
        return `
          <div class="entry">
            <p class="entry-title">Incident <span class="pill state">${entry.state}</span></p>
            <p class="entry-meta"><strong>${entry.title}:</strong> ${entry.prompt}</p>
            <p class="entry-meta"><strong>Choice:</strong> ${entry.choice}</p>
            <p class="entry-meta"><strong>Outcome:</strong> ${entry.outcome}</p>
            <p class="entry-meta"><strong>Next Mission:</strong> ${entry.nextMission}</p>
          </div>
        `;
      }
      if(entry.kind === "state"){
        return `<div class="entry"><p class="entry-title">Campaign Turn</p><p class="entry-meta">${entry.text}</p></div>`;
      }
      return "";
    });

    logDiv.innerHTML = items.join("");
  }

  const incidentBox = document.getElementById("incidentBox");
  const btnIncident = document.getElementById("btn-incident");
  const incidentModeSelect = document.getElementById("incident-mode");
  const incidentModeNote = document.getElementById("incident-mode-note");

  function applyIncidentModeUI(){
    incidentModeSelect.value = state.incidentMode;

    if(state.incidentMode === "never"){
      btnIncident.disabled = true;
      incidentModeNote.textContent = "Incidents are disabled.";
      incidentBox.style.display = "none";
      incidentBox.innerHTML = "";
    } else if(state.incidentMode === "always"){
      btnIncident.disabled = false;
      incidentModeNote.textContent = "Incidents will trigger automatically after each battle result.";
    } else {
      btnIncident.disabled = false;
      incidentModeNote.textContent = "Incidents are optional. Roll one whenever you like.";
    }
  }

  function showIncident(inc){
    if(state.incidentMode === "never") return;

    incidentBox.style.display = "block";
    incidentBox.innerHTML = `
      <div class="section-title">Incident: ${inc.title}</div>
      <p class="incidentPrompt">${inc.prompt}</p>
      <div class="choiceList" id="choiceList"></div>
      <p class="muted" style="margin-top:10px;">Choose one. Consequences are hidden until you click.</p>
    `;

    const choiceList = document.getElementById("choiceList");
    inc.choices.forEach((c, idx) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = c.text;
      btn.onclick = () => resolveIncident(inc, idx);
      choiceList.appendChild(btn);
    });

    incidentBox.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function resolveIncident(inc, choiceIndex){
    const choice = inc.choices[choiceIndex];

    state.reputation += choice.repDelta;

    // thresholds/state blurbs
    const beforeState = getStateLabel();
    checkThresholds();
    const afterState = getStateLabel();

    // incident sets next mission
    state.missionType = choice.nextMission;
    state.lastHook = null;

    state.log.push({
      kind:"incident",
      state:afterState,
      title:inc.title,
      prompt:inc.prompt,
      choice:choice.text,
      outcome:choice.outcome,
      nextMission:choice.nextMission,
      ts:Date.now()
    });

    save();

    ensureRealm();
    if(!state.general) rollGeneral();
    rollBattleHook();

    document.getElementById("out").innerHTML =
      header() +
      generalBlock() +
      section("Incident Outcome", `<p>${choice.outcome}</p>`) +
      section("Next Mission Set", `<p><strong>${state.missionType}:</strong> ${state.lastHook.text}</p>`,
        "Still flavour only ‚Äî play any battleplan you want."
      );

    // hide box after choosing
    incidentBox.style.display = "none";
    incidentBox.innerHTML = "";

    renderCurrent();
    renderLog();
  }

  function rollIncidentNow(){
    ensureRealm();
    if(!state.general) rollGeneral();
    const pool = pickIncidentPool();
    const inc = pickIncidentWeighted(pool);
    showIncident(inc);
    renderCurrent();
    renderLog();
  }

  function ensureReadyForBattle(){
    ensureRealm();
    if(!state.general) rollGeneral();
    if(!state.missionType) rollMission();
    if(!state.lastHook || state.lastHook.type !== state.missionType) rollBattleHook();
    save();
  }

  function logBattleResult(result){
    ensureReadyForBattle();

    if(result === "Win") state.reputation += 1;
    if(result === "Loss") state.reputation -= 1;

    if(state.crisis){
      if(result === "Win"){
        state.crisis = false;
        if(state.reputation <= 0) state.reputation = 1;
        state.log.push({ kind:"state", text:"Crisis of command averted. Victory restores a sliver of authority.", ts:Date.now() });
      } else if(result === "Loss"){
        state.log.push({ kind:"state", text:"Your command collapses. You cling to power, avoiding your own superiors as the war turns against you.", ts:Date.now() });
      }
    }

    checkThresholds();

    const mission = state.missionType;
    const hook = state.lastHook?.text || "(No hook)";
    const pool = afterAction[mission]?.[result.toLowerCase()] || ["After action report unavailable."];
    const after = pick(pool);

    const battleNumber = (state.log.filter(e => e.kind==="battle").length) + 1;

    state.log.push({
      kind:"battle",
      number: battleNumber,
      mission, hook, result, after,
      ts: Date.now()
    });

    // clear hook so next time you can roll fresh
    state.lastHook = null;
    save();

    document.getElementById("out").innerHTML =
      header() +
      generalBlock() +
      section("After Action", `<p><strong>${result}:</strong> ${after}</p>`) +
      section("Logged", `<p>Saved as <strong>Battle ${battleNumber}</strong> in your History.</p>`);

    renderCurrent();
    renderLog();

    // Auto incident
    if(state.incidentMode === "always"){
      rollIncidentNow();
    }
  }

  // Buttons
  document.getElementById("btn-all").onclick = () => {
    ensureReadyForBattle();
    document.getElementById("out").innerHTML =
      header() + generalBlock() + battleHookBlock() +
      section("Threat", `<p>${threat()}</p>`, "Optional points vibe-check. Ignore if you want.");
    renderCurrent(); renderLog();
  };

  document.getElementById("btn-general").onclick = () => {
    ensureRealm(); rollGeneral();
    document.getElementById("out").innerHTML = header() + generalBlock();
    renderCurrent(); renderLog();
  };

  document.getElementById("btn-mission").onclick = () => {
    ensureRealm();
    if(!state.general) rollGeneral();
    rollMission();
    rollBattleHook();
    document.getElementById("out").innerHTML = header() + generalBlock() + battleHookBlock();
    renderCurrent(); renderLog();
  };

  document.getElementById("btn-hook").onclick = () => {
    ensureRealm();
    if(!state.general) rollGeneral();
    if(!state.missionType) rollMission();
    rollBattleHook();
    document.getElementById("out").innerHTML = header() + generalBlock() + battleHookBlock();
    renderCurrent(); renderLog();
  };

  document.getElementById("btn-interlude").onclick = () => {
    ensureRealm();
    if(!state.general) rollGeneral();
    const pool = [
      ...interludes.base,
      ...(interludes[state.general?.bgKey] || [])
    ];
    document.getElementById("out").innerHTML =
      header() + generalBlock() +
      section("Interlude", `<p>${pick(pool)}</p>`,
        "Between-battle beat. Diary entry, scene, or quick roleplay moment."
      );
    renderCurrent(); renderLog();
  };

  btnIncident.onclick = () => {
    if(state.incidentMode === "never") return;
    rollIncidentNow();
  };

  document.getElementById("btn-win").onclick  = () => logBattleResult("Win");
  document.getElementById("btn-draw").onclick = () => logBattleResult("Draw");
  document.getElementById("btn-loss").onclick = () => logBattleResult("Loss");

  document.getElementById("btn-copy").onclick = async () => {
    try{ await navigator.clipboard.writeText(document.getElementById("out").innerText || ""); alert("Copied"); }
    catch(e){ alert("Copy failed. Select the text and copy manually."); }
  };

  document.getElementById("btn-copy-log").onclick = async () => {
    const lines = state.log
      .filter(e => e.kind==="battle" || e.kind==="incident" || e.kind==="state")
      .map(e => {
        if(e.kind==="battle"){
          return `Battle ${e.number} ‚Äî ${e.result}\nMission: ${e.mission}\nHook: ${e.hook}\nAfter Action: ${e.after}\n`;
        }
        if(e.kind==="incident"){
          return `Incident (${e.state})\n${e.title}: ${e.prompt}\nChoice: ${e.choice}\nOutcome: ${e.outcome}\nNext Mission: ${e.nextMission}\n`;
        }
        return `Campaign Turn\n${e.text}\n`;
      }).join("\n");
    try{ await navigator.clipboard.writeText(lines || ""); alert("Log copied"); }
    catch(e){ alert("Copy failed. Select and copy manually."); }
  };

  document.getElementById("btn-clear-log").onclick = () => {
    state.log = [];
    save();
    renderLog();
    document.getElementById("out").innerHTML = `<p class="muted">History cleared.</p>`;
  };

  document.getElementById("btn-reset").onclick = () => {
    clearAll();
    state = { log: [], reputation: 5, crisis: false, renownedTriggered: false, incidentMode: "optional" };
    document.getElementById("out").innerHTML = `<p class="muted">Reset complete. Click <strong>Generate Full Starter</strong> to begin.</p>`;
    incidentBox.style.display="none";
    incidentBox.innerHTML="";
    applyIncidentModeUI();
    renderCurrent();
    renderLog();
  };

  incidentModeSelect.onchange = () => {
    state.incidentMode = incidentModeSelect.value;
    save();
    applyIncidentModeUI();
  };

  // Initial render
  checkThresholds();
  applyIncidentModeUI();
  renderCurrent();
  renderLog();

})();
</script>
</body>
  </html>
