<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stormcast Eternals ‚Äì Story Mode Generator</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:#fff}
    .wrap{max-width:980px;margin:0 auto;border:1px solid #ddd;border-radius:12px;padding:16px;background:#fff}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .card{border:1px solid #e6e6e6;border-radius:12px;padding:12px;background:#fafafa;flex:1;min-width:260px}
    .btns{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#f3f3f3;font-weight:800;cursor:pointer}
    button.primary{background:#1976d2;border-color:#1976d2;color:#fff}
    button.danger{background:#fff;border-color:#d32f2f;color:#d32f2f}
    button.good{background:#2e7d32;border-color:#2e7d32;color:#fff}
    button.warn{background:#f9a825;border-color:#f9a825;color:#111}
    button.bad{background:#c62828;border-color:#c62828;color:#fff}

    h3{margin:0 0 6px 0}
    .muted{color:#777;font-size:12px}
    .kv{margin:0;font-size:14px;line-height:1.4}
    .kv b{display:inline-block;min-width:110px}

    .output{margin:0;padding:16px;background:#fff;border-radius:12px;min-height:220px;border:1px solid #ddd;line-height:1.55}
    .output p{margin:0 0 10px 0}
    .output strong{font-weight:700}

    .section{margin:14px 0 10px 0;padding-top:12px;border-top:1px solid #e9e9e9}
    .section-title{font-size:13px;letter-spacing:.06em;text-transform:uppercase;color:#666;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:8px}

    .log-header{display:flex;align-items:center;gap:10px;margin:12px 0 6px 0}
    .log-icon{width:34px;height:34px;border-radius:10px;border:1px solid #e1e1e1;background:#f7f7f7;display:flex;align-items:center;justify-content:center;font-size:18px}

    .help{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;border:1px solid #d0d0d0;background:#f7f7f7;color:#555;font-weight:900;font-size:12px;line-height:1;cursor:help;position:relative;user-select:none;flex:0 0 auto}
    .help:focus{outline:2px solid #1976d2;outline-offset:2px}
    .help .tip{display:none;position:absolute;z-index:50;left:50%;transform:translateX(-50%);top:24px;width:min(340px,80vw);background:#111;color:#fff;border-radius:10px;padding:10px 12px;font-size:12px;font-weight:600;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .help .tip::before{content:"";position:absolute;top:-6px;left:50%;transform:translateX(-50%);border-width:0 6px 6px 6px;border-style:solid;border-color:transparent transparent #111 transparent}
    .help:hover .tip,.help:focus .tip{display:block}

    /* Campaign entries */
    .logbox{
      border:1px solid #ddd;
      border-radius:12px;
      background:#fff;
      padding:12px;
      margin-top:10px;
    }
    .entry{
      border-top:1px solid #eee;
      padding-top:10px;
      margin-top:10px;
    }
    .entry:first-child{border-top:none;margin-top:0;padding-top:0}
    .entry-title{font-weight:900;margin:0 0 6px 0}
    .entry-meta{margin:0 0 6px 0}
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#f7f7f7;
      font-size:12px;
      font-weight:800;
      margin-left:6px;
    }
  </style>
</head>

<body>
<div class="wrap" id="storymode-stormcast">

  <h3>Stormcast Eternals ‚Äì Story Mode Generator</h3>
  <p class="muted">Optional narrative aide. No rules impact. Saved locally in your browser.</p>

  <div class="row" style="margin-top:12px;">
    <div class="card">
      <h3 style="font-size:16px;">Current Character</h3>
      <p class="kv"><b>Realm:</b> <span id="cur-realm">‚Äî</span></p>
      <p class="kv"><b>General:</b> <span id="cur-general">‚Äî</span></p>
      <p class="kv"><b>Background:</b> <span id="cur-bg">‚Äî</span></p>
      <p class="kv">
        <b>Mission:</b> <span id="cur-mission">‚Äî</span>
        <span class="help" tabindex="0" aria-label="What is Mission?">?
          <span class="tip"><b>Mission</b> is the battle type for this chapter (Incursion, Pursuit, Escalation, Revelation). Roll <b>Battle Hook</b> to get different blurbs for the same Mission.</span>
        </span>
      </p>

      <div class="btns">
        <button id="btn-reset" class="danger" type="button">Reset Character</button>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:16px;">Actions</h3>
      <div class="btns">
        <button id="btn-all" class="primary" type="button">Generate Full Starter</button>
        <button id="btn-general" type="button">Roll General</button>
        <button id="btn-mission" type="button">Roll Mission</button>
        <button id="btn-hook" type="button">Roll Battle Hook</button>
        <button id="btn-interlude" type="button">Roll Interlude</button>
        <button id="btn-copy" type="button">Copy</button>
      </div>

      <div class="section" style="border-top:none;padding-top:0;margin-top:6px;">
        <div class="section-title">
          Post-Battle Result
          <span class="help" tabindex="0" aria-label="Help">?
            <span class="tip">After you play the game, pick Win/Draw/Loss to generate an After Action report and save Battle # to the Campaign Log.</span>
          </span>
        </div>
        <div class="btns" style="margin-top:8px;">
          <button id="btn-win" class="good" type="button">Win</button>
          <button id="btn-draw" class="warn" type="button">Draw</button>
          <button id="btn-loss" class="bad" type="button">Loss</button>
        </div>
      </div>

      <p class="muted">Roll Mission once, then reroll Battle Hook as many times as you like for different blurbs.</p>
    </div>
  </div>

  <div class="log-header">
    <div class="log-icon">üìú</div>
    <h3>Campaign Log</h3>
  </div>

  <div id="out" class="output">
    <p class="muted">Ready. Click <strong>Generate Full Starter</strong>.</p>
  </div>

  <div class="logbox">
    <div class="section-title" style="margin-bottom:10px;">
      Battle History
      <span class="help" tabindex="0" aria-label="Help">?
        <span class="tip">This log is stored in your browser. Copy it into your notes/Discord if you want to keep it permanently.</span>
      </span>
    </div>

    <div class="btns" style="margin-top:0;">
      <button id="btn-copy-log" type="button">Copy Log</button>
      <button id="btn-clear-log" class="danger" type="button">Clear Log</button>
    </div>

    <div id="log"></div>
  </div>

</div>

<script>
(function(){
  const STORAGE = "woehammer_stormcast_story_v8";
  const pick = a => a[Math.floor(Math.random()*a.length)];
  const roll = n => Math.floor(Math.random()*n)+1;

  let state = {};
  try { state = JSON.parse(localStorage.getItem(STORAGE) || "{}"); }
  catch { state = {}; }

  // Ensure log array exists
  if(!Array.isArray(state.log)) state.log = [];

  const save = () => localStorage.setItem(STORAGE, JSON.stringify(state));
  const clearAll = () => localStorage.removeItem(STORAGE);

  const realms = ["Aqshy","Ghyran","Shyish","Ghur","Chamon","Ulgu"];

  const firstNames = ["Aster","Lyra","Kaelis","Brannic","Seraphine","Garran","Odrin","Merek","Siora","Eamon","Vexan","Thane"];
  const lastNames  = ["Valorn","Dawnward","Stormvein","Goldsign","Halospear","Ironlight","Truthbrand","Ashward","Skywrath","Steelward","Windstride","Brightfall"];

  const backgrounds = [
    {k:"reforged",l:"Many-Times Reforged (Memories Fraying)"},
    {k:"new",l:"Freshly Forged (New to Immortality)"},
    {k:"redeemer",l:"Redeemer (Oath to Protect the Helpless)"},
    {k:"slayer",l:"Slayer (Hunts a Specific Foe)"},
    {k:"prophet",l:"Vision-Bound (Dreams and Portents)"},
    {k:"judge",l:"Celestial Judge (No Mercy for Corruption)"}
  ];

  const missionTypes = ["Incursion","Pursuit","Escalation","Revelation"];

  const battleHooks = {
    Incursion:[
      "A sudden assault strikes an area you previously thought secure. You must muster quickly, march your force, and drive the attackers back before they slip away with whatever they came for.",
      "Raiders appear from hidden routes at dusk, striking supply wagons and outposts. If you don‚Äôt respond immediately, your campaign will starve before it truly begins.",
      "Enemy scouts and light troops push into your territory, testing your response. Break them now or they‚Äôll map every weakness you have."
    ],
    Pursuit:[
      "The enemy is falling back, wounded but dangerous. You can let them escape and regroup‚Ä¶ or you can chase them down and finish the fight on your terms.",
      "A rearguard buys time with brutal efficiency. Every mile you gain costs blood ‚Äî but if you relent, the enemy will be gone by morning.",
      "You catch glimpses of fleeing banners through smoke and rain. If you can force a battle before they reach safety, you might end this quickly."
    ],
    Escalation:[
      "The conflict widens and restraint dies. Reinforcements arrive, strongpoints are seized, and the war becomes impossible to ignore. This battle will shape the next phase of the campaign.",
      "Positions harden into front lines. Both sides commit fully ‚Äî supplies, morale, and reputations are on the line, and neutrality is no longer an option.",
      "What began as skirmishes becomes open warfare. Strike hard now, or you‚Äôll be fighting a stronger enemy later."
    ],
    Revelation:[
      "Victory uncovers something you weren‚Äôt meant to find ‚Äî a truth, a relic, or a betrayal. Now you must fight not just to win, but to control who learns what.",
      "Evidence suggests the enemy was never acting alone. Your next battle isn‚Äôt just against soldiers ‚Äî it‚Äôs against the hidden hand guiding them.",
      "A pattern becomes undeniable. The war is part of something older and darker than you knew, and this engagement may decide what comes next."
    ]
  };

  const interludes = {
    base:[
      "Mortals look to you as a myth made real ‚Äî and expect miracles.",
      "Orders from Azyr conflict with reality on the ground.",
      "A memory surfaces that should not exist."
    ],
    reforged:["You forget a name that once mattered more than victory."],
    new:["Immortality settles in ‚Äî heavier than expected."],
    redeemer:["A plea for protection arrives at the worst possible moment."],
    slayer:["You glimpse a sign that your quarry is close ‚Äî and it makes you reckless."],
    judge:["Corruption is found among allies. Justice will fracture trust."],
    prophet:["A dream leaves you certain of the next battlefield‚Ä¶ and afraid of it."]
  };

  // After Action blurbs by mission type + result
  const afterAction = {
    Incursion:{
      win:[
        "The raiders are driven off and their prize recovered. Survivors scatter, but not before you learn they were guided here by purpose ‚Äî not chance.",
        "Your counter-attack hits like a hammer. The enemy slips away, but you hold the ground and the locals speak your name with renewed hope."
      ],
      draw:[
        "The enemy withdraws with part of what they wanted. You‚Äôve stabilised the line, but the cost was higher than you expected ‚Äî and questions remain.",
        "You blunt the attack, yet the foe escapes cleanly. It feels less like a win and more like a warning."
      ],
      loss:[
        "The enemy strikes, takes what they came for, and leaves you with smoke and wounded. Whatever they wanted, they wanted it badly ‚Äî and they got it.",
        "Your force is forced back. The area is no longer secure, and the next battle will be fought on worse terms."
      ]
    },
    Pursuit:{
      win:[
        "You run them down. A retreat becomes a rout, and the enemy‚Äôs confidence breaks. The road ahead looks suddenly shorter.",
        "Your vanguard catches their rearguard and crushes it. The survivors flee without order ‚Äî and you choose the next battleground."
      ],
      draw:[
        "You press them hard, but they slip away at the last. You‚Äôve hurt them ‚Äî not enough to end it ‚Äî but enough to make them cautious.",
        "A messy fight in bad ground. Neither side claims a clean victory, but you deny them the safety they wanted."
      ],
      loss:[
        "You overextend. The enemy turns and bites, leaving you bloodied and stalled while they escape the net.",
        "The pursuit becomes a trap. You fall back, angry and regrouping, as the enemy regains momentum."
      ]
    },
    Escalation:{
      win:[
        "A decisive blow. Allies rally and neutrals reconsider ‚Äî the war has a new shape, and you helped carve it.",
        "Your victory hardens into control: roads, bridges, and morale. The campaign shifts in your favour."
      ],
      draw:[
        "The battlefield is contested and costly. The war widens, but neither side gains the clear upper hand ‚Äî yet.",
        "You hold, but you don‚Äôt break them. The front line forms here, and the next fights will be bigger."
      ],
      loss:[
        "Your position collapses under pressure. The enemy claims ground and initiative, and rumours spread of your setback.",
        "The war escalates‚Ä¶ and you‚Äôre the one forced to react. Reinforcements will be needed ‚Äî and quickly."
      ]
    },
    Revelation:{
      win:[
        "You win ‚Äî and the truth is yours to wield. The enemy fought hard to keep it hidden, which tells you everything you need to know.",
        "The battle is won, but the discovery changes everything. The next step is no longer ‚Äòvictory‚Äô ‚Äî it‚Äôs ‚Äòcontainment‚Äô."
      ],
      draw:[
        "You gain fragments, not certainty. Enough to worry you, not enough to act cleanly. The truth sits like grit under armour.",
        "The enemy retreats before answers are secured. You sense you were inches from something important."
      ],
      loss:[
        "The enemy escapes with secrets intact ‚Äî or worse, with proof of something you didn‚Äôt want to be real.",
        "You‚Äôre forced to withdraw before the truth can be seized. The cost of ignorance will be paid later."
      ]
    }
  };

  function ensureRealm(){
    if(!state.realm){ state.realm = pick(realms); save(); }
  }

  function rollGeneral(){
    const bg = pick(backgrounds);
    state.general = {
      name: `${pick(firstNames)} ${pick(lastNames)}`,
      bgKey: bg.k,
      bgLabel: bg.l
    };
    save();
  }

  function rollMission(){
    state.missionType = pick(missionTypes);
    save();
    return state.missionType;
  }

  function rollBattleHook(){
    const t = state.missionType || rollMission();
    const hook = pick(battleHooks[t] || ["(No hooks defined yet.)"]);
    state.lastHook = { type: t, text: hook };
    save();
    return state.lastHook;
  }

  function threat(){
    const r = roll(6)+roll(6);
    if(r<=3) return "Enemy weakened (-15‚Äì25%)";
    if(r<=6) return "Enemy slightly weakened";
    if(r<=9) return "Even forces";
    if(r<=11) return "Enemy reinforced (+10‚Äì15%)";
    return "Enemy heavily reinforced (+25%)";
  }

  function section(title, body, tooltipText){
    const help = tooltipText ? `
      <span class="help" tabindex="0" aria-label="Help">?
        <span class="tip">${tooltipText}</span>
      </span>` : "";
    return `
      <div class="section">
        <div class="section-title">${title} ${help}</div>
        ${body}
      </div>
    `;
  }

  function header(){ return `<p><strong>Realm:</strong> ${state.realm}</p>`; }

  function generalBlock(){
    if(!state.general) return `<p class="muted">No general yet. Click <strong>Roll General</strong>.</p>`;
    return `
      <p><strong>General:</strong> ${state.general.name}</p>
      <p><strong>Background:</strong> ${state.general.bgLabel}</p>
      <p><strong>Mission:</strong> ${state.missionType || "‚Äî"}</p>
    `;
  }

  function battleHookBlock(){
    if(!state.lastHook || state.lastHook.type !== state.missionType) rollBattleHook();
    return section(
      "Battle Hook",
      `<p><strong>${state.lastHook.type}:</strong> ${state.lastHook.text}</p>`,
      "Reroll this to get a different blurb for the same Mission type."
    );
  }

  function renderCurrent(){
    document.getElementById("cur-realm").textContent = state.realm || "‚Äî";
    document.getElementById("cur-general").textContent = state.general?.name || "‚Äî";
    document.getElementById("cur-bg").textContent = state.general?.bgLabel || "‚Äî";
  }

  function renderLog(){
    const logDiv = document.getElementById("log");
    if(!state.log.length){
      logDiv.innerHTML = `<p class="muted">No battles logged yet. Play a game, then click Win/Draw/Loss.</p>`;
      return;
    }

    logDiv.innerHTML = state.log.slice().reverse().map(entry => {
      const pill = entry.result === "Win" ? "good" : entry.result === "Draw" ? "warn" : "bad";
      return `
        <div class="entry">
          <p class="entry-title">Battle ${entry.number} <span class="pill">${entry.result}</span></p>
          <p class="entry-meta"><strong>Mission:</strong> ${entry.mission}</p>
          <p class="entry-meta"><strong>Hook:</strong> ${entry.hook}</p>
          <p class="entry-meta"><strong>After Action:</strong> ${entry.after}</p>
        </div>
      `;
    }).join("");
  }

  const out = document.getElementById("out");

  function ensureReadyForBattle(){
    ensureRealm();
    if(!state.general) rollGeneral();
    if(!state.missionType) rollMission();
    if(!state.lastHook || state.lastHook.type !== state.missionType) rollBattleHook();
    save();
  }

  function showCurrentPack(){
    out.innerHTML =
      header() +
      generalBlock() +
      battleHookBlock() +
      section("Threat", `<p>${threat()}</p>`, "Use this to slightly adjust points if you want. Ignore it if you don‚Äôt.");
  }

  function logResult(result){
    ensureReadyForBattle();

    const mission = state.missionType;
    const hook = state.lastHook?.text || "(No hook)";
    const pool = afterAction[mission]?.[result.toLowerCase()] || ["After action report unavailable."];
    const after = pick(pool);

    const nextNumber = state.log.length + 1;

    state.log.push({
      number: nextNumber,
      mission,
      hook,
      result,
      after,
      ts: Date.now()
    });

    // Clear hook so the next battle feels like a new ‚Äúchapter‚Äù
    state.lastHook = null;
    // Keep mission type (optional). If you want a new mission every time, uncomment:
    // state.missionType = null;

    save();

    out.innerHTML =
      header() +
      generalBlock() +
      section("After Action", `<p><strong>${result}:</strong> ${after}</p>`) +
      section("Logged", `<p>Saved as <strong>Battle ${nextNumber}</strong> in your Battle History.</p>`);

    renderLog();
    renderCurrent();
  }

  // Buttons
  document.getElementById("btn-all").onclick = () => {
    ensureReadyForBattle();
    showCurrentPack();
    renderCurrent();
    renderLog();
  };

  document.getElementById("btn-general").onclick = () => {
    ensureRealm();
    rollGeneral();
    out.innerHTML = header() + generalBlock();
    renderCurrent();
    renderLog();
  };

  document.getElementById("btn-mission").onclick = () => {
    ensureRealm();
    if(!state.general) rollGeneral();
    rollMission();
    rollBattleHook();
    out.innerHTML = header() + generalBlock() + battleHookBlock();
    renderCurrent();
    renderLog();
  };

  document.getElementById("btn-hook").onclick = () => {
    ensureRealm();
    if(!state.general) rollGeneral();
    if(!state.missionType) rollMission();
    rollBattleHook();
    out.innerHTML = header() + generalBlock() + battleHookBlock();
    renderCurrent();
    renderLog();
  };

  document.getElementById("btn-interlude").onclick = () => {
    ensureRealm();
    const pool = [
      ...interludes.base,
      ...(interludes[state.general?.bgKey] || [])
    ];
    out.innerHTML =
      header() + generalBlock() +
      section("Interlude", `<p>${pick(pool)}</p>`,
        "A short between-battle beat. Use it as a scene, a paragraph of diary text, or a quick roleplay moment."
      );
    renderCurrent();
    renderLog();
  };

  document.getElementById("btn-win").onclick  = () => logResult("Win");
  document.getElementById("btn-draw").onclick = () => logResult("Draw");
  document.getElementById("btn-loss").onclick = () => logResult("Loss");

  document.getElementById("btn-reset").onclick = () => {
    // Keep log? Usually no. So we wipe everything.
    state = { log: [] };
    clearAll();
    // Restore empty state locally so UI updates
    state = { log: [] };
    out.innerHTML = `<p class="muted">Reset complete. Click <strong>Generate Full Starter</strong> to begin.</p>`;
    document.getElementById("cur-realm").textContent = "‚Äî";
    document.getElementById("cur-general").textContent = "‚Äî";
    document.getElementById("cur-bg").textContent = "‚Äî";
    document.getElementById("cur-mission").textContent = "‚Äî";
    renderLog();
  };

  document.getElementById("btn-copy").onclick = async () => {
    try{ await navigator.clipboard.writeText(out.innerText || ""); alert("Copied"); }
    catch(e){ alert("Copy failed. Select the text and copy manually."); }
  };

  document.getElementById("btn-copy-log").onclick = async () => {
    const lines = state.log.map(e =>
      `Battle ${e.number} ‚Äî ${e.result}\nMission: ${e.mission}\nHook: ${e.hook}\nAfter Action: ${e.after}\n`
    ).join("\n");
    try{ await navigator.clipboard.writeText(lines || ""); alert("Log copied"); }
    catch(e){ alert("Copy failed. Select and copy manually."); }
  };

  document.getElementById("btn-clear-log").onclick = () => {
    state.log = [];
    save();
    renderLog();
    out.innerHTML = `<p class="muted">Log cleared.</p>`;
  };

  // Initial render
  document.getElementById("cur-mission").textContent = state.missionType || "‚Äî";
  renderCurrent();
  renderLog();

})();
</script>
</body>
</html>
